<?php
// Ваш API-ключ и идентификатор каталога
$apiKey = 'AQVN3rzAf7xJCbogxhZ8tZGJ89mK2bK---DyXt-n'; // Укажите ваш API-ключ
$folderId = 'b1g3c74rm4ritcke9mic'; // Укажите ваш идентификатор каталога

// Функция для поиска изображений
function searchImagesYandex($query, $page = 0, $imagesPerPage = 10) {
    global $apiKey, $folderId;

    $baseUrl = "https://yandex.ru/images-xml";
    $params = [
        'folderid' => $folderId,
        'apikey' => $apiKey,
        'text' => $query,
        'groupby' => "attr=ii.groups-on-page={$imagesPerPage}",
        'p' => $page,
        'fyandex' => 0, // Отключен семейный поиск
        'itype' => 'png', // Формат изображения
        'iorient' => 'horizontal', // Ориентация
        'isize' => 'medium', // Размер
        'icolor' => 'color', // Цвет
    ];

    // Генерация URL
    $url = $baseUrl . '?' . http_build_query($params);

    // Инициализация cURL
    $ch = curl_init($url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    $response = curl_exec($ch);
    
    // Проверяем ошибки cURL
    if (curl_errno($ch)) {
        echo 'Ошибка cURL: ' . curl_error($ch);
        return [];
    }
    curl_close($ch);

    // Проверяем, если ответ пустой
    if (empty($response)) {
        echo "Пустой ответ от API Yandex Images.";
        return [];
    }

    // Загружаем XML-ответ
    $xml = simplexml_load_string($response);

    if ($xml === false) {
        echo "Ошибка парсинга XML:";
        foreach (libxml_get_errors() as $error) {
            echo "<br>" . $error->message;
        }
        return [];
    }

    // Извлечение изображений из XML
    $images = [];
    if (isset($xml->response->results->grouping->group)) {
        foreach ($xml->response->results->grouping->group as $group) {
            if (isset($group->doc->url)) {
                $images[] = (string)$group->doc->url;
            }
        }
    }

    return $images;
}

// Пример использования
$query = "Кадры из фильма {$movie['nameRu']}";
$page = 0; // Номер страницы
$imagesPerPage = 25; // Количество картинок на странице
$images = searchImagesYandex($query, $page, $imagesPerPage);

// Вывод изображений
if (!empty($images)) {
    foreach ($images as $imageUrl) {
        echo "
            <div class='movie-card item'>
                <div class='movie-header' style='background-image: url({$imageUrl}); background-size: cover;'>
                </div>
            </div>";
    }
} else {
    echo "<p>Изображения не доступно. Yandex Search API не оплачено</p>";
}

?>